<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi Sekolah - Halaman Utama</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb;--muted:#6b7280}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial;background:var(--bg);margin:0;padding:24px}
    .container{max-width:900px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);padding:20px}
    h1{margin:0 0 8px;font-size:22px}
    p.lead{margin:0 0 16px;color:var(--muted)}
    form .row{display:flex;gap:8px;margin-bottom:10px}
    input,select,button{padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
    input:focus,select:focus{outline:2px solid rgba(37,99,235,0.12)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:8px;border-bottom:1px solid #f1f3f6;text-align:left}
    .right{display:flex;gap:8px;align-items:center}
    .danger{background:#fee2e2;color:#991b1b}
    .primary{background:var(--accent);color:white;border:none}
    .qr{width:120px;height:120px;border-radius:8px;border:1px solid #eef2ff}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:640px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Absensi Sekolah</h1>
      <p class="lead">Isi data di bawah untuk melakukan absen. Data tersimpan di perangkat dan bisa diunduh oleh guru/admin.</p>

      <form id="absenForm">
        <div class="row">
          <input id="nama" placeholder="Nama lengkap" required />
          <input id="kelas" placeholder="Kelas (contoh: 10A)" required />
        </div>
        <div class="row">
          <select id="status" required>
            <option value="Hadir">Hadir</option>
            <option value="Izin">Izin</option>
            <option value="Sakit">Sakit</option>
            <option value="Alpa">Alpa</option>
          </select>
          <input id="catatan" placeholder="Catatan (opsional)" />
        </div>
        <div class="controls">
          <button class="primary" type="submit">Kirim Absensi</button>
          <button type="button" id="resetBtn">Reset Form</button>
          <div style="margin-left:auto;text-align:right">
            <div class="small">Link/QR halaman ini (untuk share):</div>
            <img id="qrImg" class="qr" alt="QR" />
          </div>
        </div>
      </form>

      <div style="margin-top:18px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3 style="margin:0;font-size:16px">Daftar Absensi</h3>
          <div class="right">
            <button id="downloadCsv">Unduh CSV</button>
            <button id="clearAll" class="danger">Hapus Semua (admin)</button>
          </div>
        </div>

        <table id="table" aria-live="polite">
          <thead>
            <tr><th>#</th><th>Nama</th><th>Kelas</th><th>Status</th><th>Catatan</th><th>Tanggal</th></tr>
          </thead>
          <tbody></tbody>
        </table>

    <div style="height:12px"></div>

  <script>
    // Simple attendance app using localStorage
    const form = document.getElementById('absenForm');
    const nama = document.getElementById('nama');
    const kelas = document.getElementById('kelas');
    const status = document.getElementById('status');
    const catatan = document.getElementById('catatan');
    const tbody = document.querySelector('#table tbody');
    const qrImg = document.getElementById('qrImg');

    const STORAGE_KEY = 'absensi_sekolah_entries_v1';

    function loadEntries(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      }catch(e){return []}
    }
    function saveEntries(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function render(){
      const entries = loadEntries();
      tbody.innerHTML = '';
      entries.forEach((e,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(e.nama)}</td><td>${escapeHtml(e.kelas)}</td><td>${escapeHtml(e.status)}</td><td>${escapeHtml(e.catatan||'')}</td><td>${escapeHtml(e.tanggal)}</td>`;
        tbody.appendChild(tr);
      })
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\':'\\\\','"':'&quot;'}[c])); }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const entries = loadEntries();
      const now = new Date();
      const tanggal = now.toLocaleString('id-ID', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      entries.push({nama:nama.value.trim(),kelas:kelas.value.trim(),status:status.value,catatan:catatan.value.trim(),tanggal});
      saveEntries(entries);
      render();
      form.reset();
      nama.focus();
      alert('Absensi tersimpan. Terima kasih.');
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>form.reset());

    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!confirm('Hapus semua data absensi? Tindakan ini tidak bisa dibatalkan.')) return;
      localStorage.removeItem(STORAGE_KEY);
      render();
    });

    document.getElementById('downloadCsv').addEventListener('click', ()=>{
      const entries = loadEntries();
      if(!entries.length){ alert('Belum ada data.'); return; }
      const header = ['Nama','Kelas','Status','Catatan','Tanggal'];
      const csv = [header.join(',')].concat(entries.map(r => [r.nama,r.kelas,r.status,('"'+(r.catatan||'')+'"'),r.tanggal].join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'absensi_sekolah.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // initial render
    render();
    updateQr();

    // Auto-update QR when page loads from file:// or after hosting
    window.addEventListener('hashchange', updateQr);
  </script>
</body>
</html>
